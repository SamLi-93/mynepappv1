angular.module('mynepapp.controllers', [])

.controller('DashCtrl', function($scope) {})

.controller('ChatsCtrl', function($scope, Chats) {
  // With the new view caching in Ionic, Controllers are only called
  // when they are recreated or on app start, instead of every page change.
  // To listen for when this page is active (for example, to refresh data),
  // listen for the $ionicView.enter event:
  //
  //$scope.$on('$ionicView.enter', function(e) {
  //});

  $scope.chats = Chats.all();
  $scope.remove = function(chat) {
    Chats.remove(chat);
  };
})

.controller('leftmenuCtrl', ['$scope','$state','$ionicSideMenuDelegate','LoginService','Websites', function($scope,$state,$ionicSideMenuDelegate,LoginService,Websites){
    /**
     * 点击跳转到登录页面
     * @return {[type]} [description]
     */
    $scope.tologin = function(){
        console.log('tologin');
        $state.go('tab.usercenter');
        $ionicSideMenuDelegate.toggleLeft();
    };

    /**
     * 点击选择类别
     * @return {[type]} [description]
     */
    $scope.toCategory = function(catId){
        localStorage.catId = catId;
        //localStorage.catName = 
        console.log(catId);
        $state.go('tab.home',{catId:catId});
        $ionicSideMenuDelegate.toggleLeft();
    };

    /**
     * 得到分类数据
     */
    Websites.getCategory($scope);

    $scope.haslogin = typeof(localStorage.haslogin) == 'undefined'?0:localStorage.haslogin;
    $scope.username = localStorage.username;
    $scope.headimg = localStorage.headimg != 'null' ? localStorage.headimg : 'img/man1.png';
    //对登录进行侦听
    $scope.$on('loginUser', function() {
        console.log('listen on');
        //$scope.username = LoginService.getUser();
        $scope.haslogin = typeof(localStorage.haslogin) == 'undefined'?0:localStorage.haslogin;
        $scope.username = localStorage.username;
        $scope.headimg = localStorage.headimg!='null' ? localStorage.headimg : 'img/man1.png';
        //console.log(window.localStorage['username']);
    });
    $scope.$on('changeheadimg', function() {
        console.log('change headimg on');
        $scope.headimg = localStorage.headimg!='null' ? localStorage.headimg : 'img/man1.png';
    });
}])

.controller('ChatDetailCtrl', function($scope, $stateParams, Chats) {
  $scope.chat = Chats.get($stateParams.chatId);
})

.controller('AppCtrl', function($scope, $ionicPopup, $ionicModal, $timeout, $http, $ionicLoading, $location, $state) {

})
/**
 * [我的订单]
 * [by潘]
 */
.controller('OrderCtrl', function($scope, $ionicPopup, $ionicModal, $timeout, $http, $ionicLoading, $location, $state,Websites) {
  if (localStorage.haslogin != 1) {
      $state.go("tab.usercenter");
  }
  $ionicLoading.show({
      template: 'Loading...'
  });
  Websites.getOrderlist($scope).success(function(data){
    $scope.orderlist = data;
  }).error(function(data){

  })
  $ionicLoading.hide();
  //订单下拉刷新
  $scope.doRefresh = function(){
    Websites.getOrderlist($scope).success(function(data){
      $scope.orderlist = data;
      $scope.$broadcast('scroll.refreshComplete');
    }).error(function(data){})
  }
  //取消订单
  $scope.ordercancel = function(index,id){
    var confirmPopup = $ionicPopup.confirm({
          title: '取消订单？',
          buttons: [{ //Array[Object] (可选)。放在弹窗footer内的按钮。
            text: '否',
            type: 'button-balanced',
          }, {
            text: '是',
            type: 'button-calm',
            onTap: function(e) {
              // 返回的值会导致处理给定的值。
              return true;
            }
          }]
      });

      confirmPopup.then(function(res) {
        if(res) {
          Websites.Ordercancel($scope,id).success(function(data){
            if(data.status=='1'){
              $scope.orderlist[index]['status'] = '2';
              $scope.showMessage('订单取消成功');
            }
          }).error(function(data){
            $scope.showMessage('订单取消失败');
          })
        }
      });

  }
  $scope.showMessage = function(title){
    $ionicLoading.show({
      template: title
    });
    $timeout(function() {
      $ionicLoading.hide();
    }, 1000);
  }

})

/**我的问答**/
.controller('AnswerlistCtrl', function($scope, Websites, $ionicPopup, $ionicModal, $timeout, $http, $ionicLoading, $location, $state,$ionicScrollDelegate) {
  if (localStorage.haslogin != 1) {
        $state.go("tab.usercenter");
  }
  console.log($scope);

  $ionicLoading.show({
      template: 'Loading...'
  });
  $scope.userid = window.localStorage['userid'];
  //获取帖子
  Websites.getAnswerlist($scope);
  $ionicLoading.hide();
  //设置发帖内容（默认为空）
  $scope.answercreate = {
    'title': '',
    'content': ''
  };
  $scope.setscroll = function(){
    $ionicScrollDelegate.resize();
  }
  //定义发帖视图
  $ionicModal.fromTemplateUrl('templates/answer-create.html', {
    scope: $scope
  }).then(function(modal) {
    $scope.answer = modal;
  });
  //帖子刷新
  $scope.doRefresh = function() {
    Websites.getAnswerlist($scope);
    //Stop the ion-refresher from spinning
    $scope.$broadcast('scroll.refreshComplete');
  }
  //推出发帖视图
  $scope.showanswer = function(){
    $scope.answer.show();
  } 
  //隐藏发帖视图
  $scope.closecreate = function(){
    $scope.answer.hide();
  } 
  $scope.create = function(){
	  console.log($scope.answercreate.courseid);
    if (!$scope.answercreate.courseid || $scope.answercreate.title == ''  || $scope.answercreate.content == '' ) {
                var alertPopup = $ionicPopup.alert({
                    title: '格式不合法',
                    template: '请确认课程或标题或内容不能为空！',
                    buttons: [{ //Array[Object] (可选)。放在弹窗footer内的按钮。
                      text: 'OK',
                      type: 'button-calm',
                    }]
                });
    }else{
      //$http.jsonp(ENV.postUrl + 'apicatechism/create/userid/'+$scope.userid+'/title/'+$scope.answercreate.title+'/content/'+$scope.answercreate.content+'?callback=JSON_CALLBACK')
      $http.jsonp(ENV.apiUrl + 'mobileanswer/create?access-token='+localStorage.access_token+'&courseid='+$scope.answercreate.courseid+'&title='+$scope.answercreate.title+'&content='+$scope.answercreate.content+'&callback=JSON_CALLBACK')
        .then(function(res){
          //console.log(res.data);
          //新发帖子添加到发帖列表
          //$scope.answerlist.push(res.data);
		  Websites.getAnswerlist($scope);
          //console.log($scope.answerlist);
          //隐藏发帖视图
          $scope.answer.hide();
          //发帖成功清除数据
          $scope.answercreate = {
            'title': '',
            'content': ''
          };
      })
    }
  }
})

.controller('AnswerCtrl', function($scope,$stateParams,Websites,$http,$ionicLoading) {
  if (localStorage.haslogin != 1) {
        $state.go("tab.usercenter");
  }
  $ionicLoading.show({
      template: 'Loading...'
  });
  var userid = window.localStorage['userid'];
  //帖子id
  $scope.answer_id = $stateParams.id;
  $scope.discuss = {'con':''};
  //获取帖子内容
  Websites.getAnswerDetail($scope);
  $ionicLoading.hide();
  $scope.answersubmit = function() {
    console.log($scope.discuss.con.length);
    $http.jsonp(ENV.postUrl + 'apicatechism/submit/userid/'+userid+'/id/'+$scope.answer_id+'/content/'+$scope.discuss.con+'?callback=JSON_CALLBACK')
      .then(function(res){
        var r_data = res.data;
        r_data.num = $scope.answerlist.length+1;
        //新发帖子添加到发帖列表
        //console.log($scope.answerlist.length);
        $scope.answerlist.push(r_data);
        //发帖成功清除数据
        $scope.discuss.con = "";
    })

  }
  $scope.doRefresh = function() {
    Websites.getAnswerDetail($scope);
    $scope.$broadcast('scroll.refreshComplete');
  }

})
.controller('LearnCtrl', function($scope,$stateParams,Websites,$http,$ionicLoading,$rootScope) {
  if (localStorage.haslogin != 1) {
        $state.go("tab.usercenter");
  }
  //隐藏header-bar
  //$rootScope.showFooterBar.show = false;
  console.log($rootScope);
  $ionicLoading.show({
      template: 'Loading...'
  });
  //获取帖子内容
  //Websites.getAnswerDetail($scope);
  $ionicLoading.hide();
})
/*我的练习*/
.controller('PracticeCtrl', function($scope,$ionicPopup,$stateParams,Websites,$http,$ionicLoading,$rootScope,$ionicViewSwitcher) {
  if (localStorage.haslogin != 1) {
        $state.go("tab.usercenter");
  }
  /*//强制显示返回button，默认情况下tabs里面独立页面不显示back button
  $scope.$on('$ionicView.beforeEnter', function (event, viewData) {
      viewData.enableBack = true;
  });
  //返回的动画效果，默认情况下强制显示的返回button无动画效果
  $scope.$on('$ionicView.beforeLeave', function (event, viewData) {
      $ionicViewSwitcher.nextDirection("back");
  });*/
 
  $ionicLoading.show({
      template: 'Loading...'
  });
  var userid = window.localStorage['userid'];
  console.log('PracticeCtrl');
  //$scope.processhide = true;
  $scope.errornum = 0;
  /*Websites.getMonilist($scope,userid).success(function(data) {
  }).error(function(data) {
  });
  Websites.getErrorlist($scope,userid).success(function(data) {
    $scope.errornum = data.responseData.length;
    //$ionicLoading.hide();
    console.log(data);
  }).error(function(data){
    //加载失败
  });*/
  $scope.productid = $stateParams.productid;
  console.log($scope.productid);
  Websites.getPracticelist($scope,userid,$stateParams.productid).success(function(data) {
    $scope.plist = data;
    console.log(data);
    //$ionicLoading.hide();
  }).error(function(data){
    //加载失败
  });
  $ionicLoading.hide();
//Sam   --------删除错题列表
  $scope.onItemDelete = function(){
    var confirmPopup = $ionicPopup.confirm({
          title: '确认删除？',
          cancelText: '取消',
          okText: '确定'
      });
      confirmPopup.then(function(res) {
        if(res) {
          console.log('You are sure');
          $http.get(ENV.postUrl + 'mobileerror/delete/userid/13/course_id/9')
            .then(function(res){
              console.log(res.data);
          })              
          $scope.errorlist = '';
        }else{
            console.log('You are not sure');
        }
      });
    console.log('test');
  }
})
//学习记录
.controller('RecordCtrl', function($scope,$stateParams,Websites,$http,$ionicLoading,$rootScope,$state,$ionicViewSwitcher) {
  if (localStorage.haslogin != 1) {
        $state.go("tab.usercenter");
  }
  //强制显示返回button，默认情况下tabs里面独立页面不显示back button
  $scope.$on('$ionicView.beforeEnter', function (event, viewData) {
      viewData.enableBack = true;
  });
  //返回的动画效果，默认情况下强制显示的返回button无动画效果
  $scope.$on('$ionicView.beforeLeave', function (event, viewData) {
      $ionicViewSwitcher.nextDirection("back");
  });
  $scope.plan_empty = "";
  $scope.search_empty = "";
  $scope.process_empty = "";
  $ionicLoading.show({
      template: 'Loading...'
  });
  $scope.userid = window.localStorage['userid'];
  //教学计划
  Websites.getPlanlist($scope).success(function(data) {
    if($scope.planlist.length==0){
      $scope.plan_empty = "无教学计划";
    }
  }).error(function(data){
      //加载失败
      console.log('failure');
  });
  Websites.getSearchlist($scope).success(function(data) {
    if($scope.searchlist.length==0){
      $scope.search_empty = "无成绩查询";
    }
  }).error(function(data){
      //加载失败
      console.log('failure');
  });
  Websites.getProcesslist($scope).success(function(data) {
    if($scope.processlist.length==0){
      $scope.process_empty = "无学习进度";
    }
  }).error(function(data){
      //加载失败
      console.log('failure');
  });
  $ionicLoading.hide();
})
/**
 * [教学计划]
 * [by潘]
 */
.controller('PlanCtrl', function($scope,$stateParams,Websites,$http,$ionicLoading,$rootScope,$ionicHistory) {
  $ionicLoading.show({
      template: 'Loading...'
  });
  $scope.userid = window.localStorage['userid'];
  //教学计划
  Websites.getPlanlist($scope);
  $ionicLoading.hide();
  $scope.back = function(){
    console.log(1);
    $ionicHistory.goBack();
  }
})
/**
 * [电子书列表]
 * [by潘]
 */
.controller('BooklistCtrl', function($scope,$stateParams,Websites,$http,$ionicLoading,$rootScope,$ionicHistory) {
  var courseid = $stateParams.courseid;
  $scope.courseid = courseid;
  console.log(courseid);
  console.log($scope.courseid);
  Websites.getBooklist($scope,courseid).success(function(data){

  })
})
/**
 * [电子书内容]
 * [by潘]
 */
.controller('BookReadCtrl', function($scope,$stateParams,Websites,$http,$state,$ionicLoading,$rootScope,$ionicHistory,$ionicModal) {
  //讲义id
  var bookid = $stateParams.bookid;
  //获取讲义章节
  var chapter = 1;
  var page = 1;
  var localbook = window.localStorage['book'];
  //是否有历史记录
  if(localbook != undefined){
    var arr = JSON.parse(localbook);
    console.log(arr[bookid]);
    if(arr[bookid]){
      var b_arr = arr[bookid].split(",");
      chapter = b_arr[0];
      page = b_arr[1];
    }
  }

  Websites.getBook($scope,bookid,chapter).success(function(data){
    JobReader.init_reader(bookid,chapter,page);
  })

  //定义电子书目录视图
  $ionicModal.fromTemplateUrl('templates/book-menu.html', {
    scope: $scope,
  }).then(function(modal) {
    $scope.bookmenu = modal;
  });
  $scope.showmenu = function () {
    console.log('bookshow');
    $scope.bookmenu.show();
    pageAction.hide();
  }
  $scope.tomenu = function(id){
    $scope.bookmenu.hide();
    Websites.bookmenuto($scope,bookid,id).success(function(){
      JobReader.refurbish();
    });
    //保存本地浏览记录
    arr= {};
    arr[bookid] = id+',0';
    window.localStorage['book'] = JSON.stringify(arr);
  }

  $scope.showMessage = function(){
    console.log(222);
  }
  $scope.readback = function(){
    $ionicHistory.goBack();
  }
  var self = this;
  $scope.$watch(function(){
    JobReader.refurbish();
    return self.book;
  })

})
/**
 * [学习记录成绩查询页面]
 * [by潘]
 */
.controller('SearchCtrl', function($scope,$stateParams,Websites,$http,$ionicLoading,$rootScope) {
  $ionicLoading.show({
      template: 'Loading...'
  });
  $scope.userid = window.localStorage['userid'];
  //教学计划
  Websites.getSearchlist($scope);
  $ionicLoading.hide();
})
/**
 * [我的笔记]
 * [by潘]
 */
.controller('NoteCtrl', function($scope,$stateParams,Websites,$http,$ionicLoading,$rootScope,$ionicScrollDelegate,$timeout) {
  $ionicLoading.show({
      template: 'Loading...'
  });
  $scope.selected = false;
  userid = window.localStorage['userid'];
  //教学计划
  Websites.getNotelist($scope).success(function(data){
  });
  $ionicLoading.hide();
  //删除笔记
  $scope.deletenote = function(index1,index2,id){
    Websites.DeleteNote($scope,id).success(function(data){
      //删除成功
      if(data.flag==1){
        var str = $scope.notelist[index1].detail;
        str.splice(index2,1);
        $scope.notelist[index1].num = $scope.notelist[index1].num-1;
        if($scope.notelist[index1].num==0){
          $scope.notelist.splice(index1,1);
        }
        $scope.setscroll();
      }else{
        //删除失败
        $ionicLoading.show({
          template: '删除出错'
        });
        $timeout(function() {
          $ionicLoading.hide();
        }, 1000);
      }
    })
  }
  //重置滚动条
  $scope.setscroll = function(){
    $ionicScrollDelegate.resize();
  }
})
/**
 * [课程搜索页面]
 * [by潘]
 */
.controller('CourseSearchCtrl', function($scope,$stateParams,Websites,$http,$ionicLoading,$rootScope,$state) {
  $ionicLoading.show({
      template: 'Loading...'
  });
  $scope.searchlist = ["会计基础","学前教育","心理学"];
  $scope.userid = window.localStorage['userid'];
  $scope.search = {};
  //教学计划
  //Websites.getSearchlist($scope);
  $scope.toresult = function(){
    //console.log('toresult');
    //console.log($scope.search);
    $state.go('tab.result', {content:$scope.search.value});
  }
  $ionicLoading.hide();
})
/**
 * [用户注册页面]
 * [by潘]
 */
.controller('RegisterCtrl', function($scope, $state, $ionicPopup, $ionicLoading, $timeout,LoginService) {

    $scope.data = {};
    $scope.timetext = '短信验证码';
    $scope.timeable = false;
    $scope.gotoaccount = function() {
        $state.go("tab.usercenter");
    }
    
    //打开服务条款
    $scope.openagree = function() {
      var alertPopup = $ionicPopup.alert({
          title: '用户服务条款',
          template: '<div >经习近平主席和中央军委批准，中国军队派出工作组于6月2日乘空军飞机赶赴马里加奥地区，代表习主席和中央军委看望慰问执行维和任务的中国官兵，做好遇袭伤亡人员善后和救治工作，协调联合国马里多层面综合稳定特派团和马里政府采取切实措施，确保维和部队安全，有效执行维和任务。工作组由国防部维和事务办公室代主任苏广辉少将带队，成员由解放军总医院的医疗专家和任务部队有关人员组成。中国将继续坚定支持联合国维和行动，坚定反对一切形式的恐怖主义，坚定维护世界和平。</div>',
          okText:'我同意',
          okType:'button-calm'
      });
    };
    //注册
    $scope.register = function() {
        //注册功能
        //检测用户输入
        //判断空的输入
        var code = $scope.data.code;
        var phone = $scope.data.phone;
        var password = $scope.data.password;
        if (checkPhone(phone)&&checkPassword(password)&&checkCode(code)) {
            //提交api，进行注册功能
            LoginService.register(code, phone, password).success(function(data) {
              if(data.success==1){
                $scope.showMessage('注册成功');
                $state.go("tab.usercenter");
              }else{
                $scope.showMessage('注册失败');
              }
            }).error(function(){
              $scope.showMessage('注册出错~！~');
            });
        } else {
          if(!checkPhone(phone)){
            $scope.showMessage('请输入正确手机号！');
          }else if(!checkPassword(password)){
            $scope.showMessage('密码至少6位！');
          }else{
            $scope.showMessage('请输入正确验证码！');
          }
        }
    };
    //验证邮箱
    var checkMail = function(szMail) {
        var szReg = /^([a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+((\.[a-zA-Z0-9_-]{2,3}){1,2})$/;
        var bChk = szReg.test(szMail);
        return bChk;
    }
    //验证手机
    var checkPhone = function(a){
      var str = /^(13[0-9]|14[0-9]|15[0-9]|18[0-9])\d{8}$/i;
      var flag = str.test(a);
      return flag;
    }
    //验证密码
    var checkPassword = function(b){
      var flag = false;
      if(b!=undefined){
        if(b.length>=6){
          flag = true;
        }
      }
      return flag;
    }
    //验证验证码
    var checkCode = function(num){
      var flag = false;
      if(num!=undefined){
        if(!isNaN(num)&&num.length==4){
          flag = true;
        }
      }
      return flag;
    }
    //验证短信发送时间
    var checkTime = function(){
      var flag = false;
      var time = $scope.timetext;
      if(time=='短信验证码'){
        flag = true;
      }
      return flag;
    }
    //发送验证码
    $scope.sendcode = function(){
      var phone = $scope.data.phone;
      if(checkPhone(phone)&&checkTime()){//可以发送验证码
        LoginService.SendCode($scope,$scope.data.phone).success(function(data){
          $scope.showMessage('验证码已发送，注意查收!');
          $scope.timetext = 59;
          $scope.timeable = true;
          $scope.showTime();
        }).error(function(data){
          $scope.showMessage('验证码发送失败!');
        })
      }else{
        //不可以发送验证码
        if(!checkPhone(phone)){
          $scope.showMessage('请输入正确手机号');
        }
      }
    }
    //消息提示
    $scope.showMessage = function(title){
      $ionicLoading.show({
        template: title
      });
      $timeout(function() {
        $ionicLoading.hide();
      }, 1000);
    }
    //短信倒计时
    $scope.showTime = function(){
      if($scope.timetext>0){
        $timeout(function() {
          $scope.timetext--;
          $scope.showTime();
        }, 1000);
      }else{
        $scope.timetext = "短信验证码";
        $scope.timeable = false;
      }
    }
})

/**
 * [课程搜索结果]
 * [by潘]
 */
.controller('ResultCtrl', function($scope,$stateParams,Websites,$http,$ionicLoading,$rootScope, $state,$ionicHistory) {
  console.log($stateParams);
  $scope.course_empty = "";
  $ionicLoading.show({
      template: 'Loading...'
  });
  $scope.result = {'value':$stateParams.content};
  Websites.getCourseBykey($scope, $stateParams.content).success(function(data) {
      console.log('success');
      var list = data.responseData;
      if(list.length==0){
        $scope.course_empty = "搜索结果为空";
      }
      $ionicLoading.hide();
    }).error(function(data){
      //加载失败
      console.log('failure');
      $ionicLoading.hide();
  });
  //$scope.resultlist = [{'img':'http://10.82.97.236/mynepapp/www/img/cnsc_mbimg.png','name':'技能《出纳速成》','teacher_names':'陈聪','class_time':'2','free':'0','price':'20'},{'img':'','name':'技能《出纳速成》','teacher_names':'陈聪','class_time':'2','free':'1','price':'30'}];
  console.log($scope.resultlist);
  $scope.doresult = function(){
    $scope.course_empty = "";
    $ionicLoading.show({
      template: 'Loading...'
    });
    Websites.getCourseBykey($scope, $scope.result.value).success(function(data) {
      console.log('success');
      var list = data.responseData;
      if(list.length==0){
        $scope.course_empty = "搜索结果为空";
      }
      $ionicLoading.hide();
    }).error(function(data){
        //加载失败
        console.log('failure');
        $ionicLoading.hide();
    });
  }
  $scope.goBack = function() {
    //$ionicNavBarDelegate.back();
    $ionicHistory.goBack(-2);
  };
})
/**
 * [课程列表]
 * [by潘]
 */
.controller('CourselistCtrl', function($scope,$stateParams,Websites,$http,$ionicLoading,$rootScope, $state) {
  /*if (localStorage.haslogin != 1) {
        $state.go("tab.account");
  }*/
  $ionicLoading.show({
    template: '数据加载中...'
  });
  console.log('CourselistCtrl');
  var type_id = $stateParams.id;

  //加载分页默认配置
  var coursepage = 0;
  var courselimit = '6';

  $scope.course_title = $stateParams.name;
  $scope.course_empty = "";

  //加载更多配置true：是，false：否，默认不开启
  $scope.moreDataCanBeLoaded = false;

  //获取课程
  Websites.getCourselist($scope, type_id,coursepage,courselimit).success(function(data) {
      console.log('success');
      var courselist = data.responseData;
      $scope.courselist = courselist;
      //var list = data.responseData;
      if(courselist.length==0){
        $scope.course_empty = "暂无数据";
      }
      //返回数据数量与分页数量一致，开启加载更多配置
      if(courselist.length == courselimit){
        $scope.moreDataCanBeLoaded = true;
      }
      $ionicLoading.hide();
  }).error(function(data){
      //加载失败
      $scope.course_empty = "加载失败";
      console.log('failure');
      $ionicLoading.hide();
  });

  //加载更多
  $scope.loadMore = function() {
    console.log('loadmore');
    coursepage = coursepage + 1;
    Websites.getCourselist($scope, type_id,coursepage,courselimit).success(function(data) {
      console.log('success');
      for (var i = 0; i <data.responseData.length; i++) {
        $scope.courselist.push(data.responseData[i]);
      };
      console.log(data.responseData);
      console.log($scope.courselist);
      var returnlist = data.responseData;
      if(returnlist.length<6){
        $scope.moreDataCanBeLoaded = false;
      }
      $scope.course_empty = "无更多";
      $scope.$broadcast('scroll.infiniteScrollComplete');
      $ionicLoading.hide();
      
    }).error(function(data){
      //加载失败
      $scope.course_empty = "加载失败";
      console.log('failure');
      $ionicLoading.hide();
    });
  };
  //数据重新加载
  $scope.doRefresh = function() {
    Websites.getCourselist($scope, type_id,'0',courselimit).success(function(data) {
      console.log('success');
      var returnlist = data.responseData;
      if(returnlist.length<6){
        $scope.moreDataCanBeLoaded = false;
      }
      $scope.courselist = data.responseData
      //$scope.course_empty = "无更多";
      $scope.$broadcast('scroll.infiniteScrollComplete');
      $ionicLoading.hide();
      
    }).error(function(data){
      //加载失败
      $scope.course_empty = "加载失败";
      console.log('failure');
    });
    $scope.$broadcast('scroll.refreshComplete');
  }
})
/**
 * [课程更多列表]
 * [by潘]
 */
.controller('CoursefreeCtrl', function($scope,$stateParams,Websites,$http,$ionicLoading,$rootScope, $state) {
  var free = $stateParams.free;
  var title = "畅销好课";
  if(free==1){
    title = "免费好课";
  }
  $scope.course_title = title;
  $ionicLoading.show({
        template: 'Loading...'
  });
  Websites.getCoursefree($scope, free).success(function(data) {
      console.log('success');
      var list = data.responseData;
      if(list.length==0){
        $scope.course_empty = "暂无数据";
      }
      $ionicLoading.hide();
  }).error(function(data){
      //加载失败
      console.log('failure');
      $ionicLoading.hide();
  });
  $scope.doRefresh = function() {
    $ionicLoading.show({
        template: 'Loading...'
    });
    Websites.getCoursefree($scope,free).success(function(data) {
      var list = data.responseData;
      if(list.length==0){
        $scope.course_empty = "暂无数据";
      }
      $ionicLoading.hide();
    }).error(function(data) {
      $ionicLoading.hide();
    });
    //Stop the ion-refresher from spinning
    $scope.$broadcast('scroll.refreshComplete');
  }

  
})
.controller('ProcessCtrl', function($scope,$stateParams,Websites,$http,$ionicLoading,$rootScope,$state) {
  $ionicLoading.show({
      template: 'Loading...'
  });
  $scope.userid = window.localStorage['userid'];
  //$scope.processhide = true;
  Websites.getProcesslist($scope).success(function(data) {
    $ionicLoading.hide();
  }).error(function(data) {
    //$scope.processhide = false;
    $ionicLoading.hide();
  });

  console.log($scope);
  console.log($scope.processlist);
  $scope.doRefresh = function() {
    console.log(1);
    $ionicLoading.show({
        template: 'Loading...'
    });
    Websites.getProcesslist($scope).success(function(data) {
      $ionicLoading.hide();
    }).error(function(data) {
      $ionicLoading.hide();
    });
    //Stop the ion-refresher from spinning
    $scope.$broadcast('scroll.refreshComplete');
  }

})
/**
 * [模拟练习]
 * [by潘]
 */
.controller('MoniCtrl', function($scope,$stateParams,Websites,$http,$ionicLoading,$rootScope,$state) {
  if (localStorage.haslogin != 1) {
        $state.go("tab.usercenter");
  }
  $ionicLoading.show({
      template: 'Loading...'
  });
  var userid = window.localStorage['userid'];
  console.log('MoniCtrl');
  //$scope.processhide = true;
  Websites.getMonilist($scope,userid).success(function(data) {
    $ionicLoading.hide();
  }).error(function(data) {
    $ionicLoading.hide();
  });

  //console.log($scope);
  //console.log($scope.processlist);
  $scope.doRefresh = function() {
    console.log(1);
    $ionicLoading.show({
        template: 'Loading...'
    });
    Websites.getMonilist($scope,userid).success(function(data) {
      $ionicLoading.hide();
    }).error(function(data) {
      $ionicLoading.hide();
    });
    //Stop the ion-refresher from spinning
    $scope.$broadcast('scroll.refreshComplete');
  }

})

/**
 * [答题页面]
 * [by潘]
 */
.controller('QuestionCtrl', function($scope,$stateParams,Websites,$http,$ionicLoading,$ionicSlideBoxDelegate,$ionicPopup,$ionicModal,$ionicHistory,$state,$timeout) {
  if (localStorage.haslogin != 1) {
        $state.go("tab.usercenter");
  }
  // $scope.checked = true;
  console.log('QuestionCtrl');
  $ionicLoading.show({
      template: 'Loading...'
  });
  $scope.choice = {'0':'A','1':'B','2':'C','3':'D'};
  //定义成绩结果
  $ionicModal.fromTemplateUrl('templates/question-result.html', {
    scope: $scope
  }).then(function(modal) {
    $scope.modal = modal;
    //$scope.modal.show();
  });
  $scope.qindex = 1;
  $scope.rate = '0';
  $scope.pagetitle = '练习';
  $scope.isUpActive = false;
  $scope.isDownActive = true;
  //定义答题卡
  $ionicModal.fromTemplateUrl('templates/question-card.html', {
    scope: $scope
  }).then(function(modal) {
    $scope.card = modal;
  });
  //答题开始时间
  var myDate1 = new Date();
  var starttime = myDate1.getTime();
  var endtime = "";
  Websites.getQuestion($scope,$stateParams.t_id,$stateParams.course_id).success(function(data){
        if(data['total']==0){
          $ionicLoading.hide();
          var alertPopup = $ionicPopup.alert({
              title: '提示框',
              template: '该试卷暂时无法练习，请联系老师',
              buttons: [{ //Array[Object] (可选)。放在弹窗footer内的按钮。
                  text: 'OK',
                  type: 'button-calm',
              }]
          });
          alertPopup.then(function(res) {
            //console.log('Thank you for not eating my delicious ice cream cone');
            $ionicHistory.goBack();
          });
        }else{
          $scope.pagetitle = data['pagetitle'];
          $scope.questions = data['question'];
          $scope.total = data['total'];
          
          $scope.cardlist = data['card'];
          $scope.params = data['params'];
          $ionicSlideBoxDelegate.update();
          $ionicLoading.hide();

        }
  })

  $scope.slideHasChanged = function(index){
    var num = $scope.total;
    $scope.qindex = index+1;
    $scope.rate =  index/(num-1)*100-4;
    //翻页判断按钮颜色
    if(index+1==num){
      $scope.isDownActive = false;
    }else{
      $scope.isDownActive = true;

    }
   
    if(index!=0){
      $scope.isUpActive = true;
    }else{
      $scope.isUpActive = false;

    }
    console.log($scope.qindex);
    console.log($scope.rate);
    $(document).scrollTop(); 
    //window.localStorage[pinde] = $ionicSlideBoxDelegate.currentIndex();

  }
  var self = this;
  $scope.$watch(function(){
      return self;
  })
  $scope.showcard = function(){
    $scope.card.show();
  }
  $scope.toquestion = function(id){
    $ionicSlideBoxDelegate.slide(id-1);
    $scope.card.hide();
  }
  $scope.hidecard = function(){
    $scope.card.hide();
  }
  //上一题
  $scope.previous = function(){
    $ionicSlideBoxDelegate.previous();
  }
  //下一题
  $scope.next = function(){
    $ionicSlideBoxDelegate.next();
  }
  $scope.change = function(){

  }
  $scope.setanswer = function(id,val,qnum,qtype){
    console.log(qnum);
    $http.jsonp(ENV.apiUrl + 'mobilepractice/setanswer?id='+id+'&answer='+val+'&access-token='+localStorage.access_token+'&callback=JSON_CALLBACK').then(function(res){
      $scope.cardlist[qtype][qnum+1]['do'] = 'done';
    })

  }
  $scope.setanswercheckbox = function(id,val,qnum,qtype){
      console.log(id+'message'+val);
      $http.jsonp(ENV.apiUrl + 'mobilepractice/Setanswercheckbox?id='+id+'&&answer='+val+'&&callback=JSON_CALLBACK').then(function(res){
        $scope.cardlist[qtype][qnum+1]['do'] = 'done';
      })
    }
  $scope.repeat = function(){
    $scope.modal.hide();
    $ionicLoading.show({
      template: 'Loading...'
    });
    Websites.getQuestion($scope,$stateParams.t_id,$stateParams.course_id).success(function(data){
        if(data['total']==0){
          $ionicLoading.hide();
          var alertPopup = $ionicPopup.alert({
              title: '提示框',
              template: '该试卷暂时无法练习，请联系老师',
              buttons: [{ //Array[Object] (可选)。放在弹窗footer内的按钮。
                  text: 'OK',
                  type: 'button-calm',
              }]
          });
          alertPopup.then(function(res) {
            //console.log('Thank you for not eating my delicious ice cream cone');
            $ionicHistory.goBack();
          });
        }else{
          $scope.pagetitle = data['pagetitle'];
          $scope.questions = data['question'];
          $scope.total = data['total'];
          $scope.cardlist = data['card'];
          $scope.params = data['params'];
          $ionicSlideBoxDelegate.update();
          $ionicSlideBoxDelegate.slide(0);
          $scope.qindex = 1;
          $scope.rate =  "0";
          $timeout(function() {
            $ionicLoading.hide();
          }, 2000);
        }
    })
  }
  /*$scope.setanswertext = function(id,val,qnum,qtype){
    console.log(id);
    console.log(val);
    if(val!=""&&val!=undefined){
      $http.jsonp(ENV.postUrl + 'apipractice/settextanswer/id/'+id+'/answer/'+val+'?callback=JSON_CALLBACK').then(function(res){
        $scope.cardlist[qtype][qnum+1]['do'] = 'done';
      })
    }
  }*/
  /**
     * 交卷
     * @return {[type]} [description]
  **/
    $scope.doSubmitPhase = function(t_id,pageid){
      console.log('submitphase');
        var confirmPopup = $ionicPopup.confirm({
          title: '交卷',
          template: '确定提交本次测验?',
            
          buttons: [{ //Array[Object] (可选)。放在弹窗footer内的按钮。
            text: 'Cancel',
            type: 'button-balanced',
          }, {
            text: 'OK',
            type: 'button-calm',
            onTap: function(e) {
              // 返回的值会导致处理给定的值。
              return true;
            }
          }]
      });
      confirmPopup.then(function(res) {
        if(res) {
            console.log('You are sure');
            //Edetail.submitphase.get({userid:window.localStorage['userid'],t_id:t_id,pageid:pageid});
            //$location.path('/app/pageresult/userid/'+window.localStorage['userid']+'/t_id/'+t_id);
            $scope.modal.show();
            $scope.card.hide();
            Websites.getResult($scope).success(function(data) {
              $scope.result = data;
            }).error(function(data) {
            });
            $scope.lasttime = $scope.timediff();
            console.log($scope.lasttime);
            $scope.examurl = '/tab/practice';
            //window.localStorage['examurl'] = '/app/phaselist';
        }else{
            console.log('You are not sure');
        }
      });
    }
  //做题时间
  $scope.timediff = function(){
    var myDate2 = new Date();
    var endtime = myDate2.getTime();  
    time = endtime-starttime;
    var days    = Math.floor(time/(24*3600*1000));
    var leave1  = time%(24*3600*1000);    //计算天数后剩余的毫秒数
    var hours   = Math.floor(leave1/(3600*1000));
    //计算相差分钟数
    var leave2  = leave1%(3600*1000);        //计算小时数后剩余的毫秒数
    var minutes =  Math.floor(leave2/(60*1000));
    //计算相差秒数
    var leave3  = leave2%(60*1000);      //计算分钟数后剩余的毫秒数
    var seconds =  Math.round(leave3/1000);
    var str = '';
    if(days>0){
      str = days+'天';
    }
    if(hours>0){
      str += hours+':';
    }
    if(minutes>0){
      if(minutes>=10){
        str += minutes+':';
      }else{
        str += "0"+minutes+':';
      }
    }else{
      str += '00:';
    }
    if(seconds>0){
      if(seconds>=10){
        str += seconds;
      }else{
        str += "0"+seconds;
      }
    }else{
      str += '00';
    }
    return str;
  }
  $scope.gourl = function(url){
    console.log(url);
    $location.path(url);
    $scope.modal.hide();
  }
  $scope.resultback = function(){
    console.log('resultback');
    $state.go("tab.practice",{productid:$stateParams.productid});
    $scope.modal.hide();
  }
})
.controller('ViewCtrl', function($scope,$stateParams,Websites,$http,$ionicLoading,$state) {
  if (localStorage.haslogin != 1) {
        $state.go("tab.usercenter");
  }
  console.log('ViewCtrl');
  $ionicLoading.show({
      template: 'Loading...'
  });
  $scope.userid = window.localStorage['userid'];
  $scope.planid = $stateParams.planid;
  $scope.courseid = $stateParams.courseid;
  //获取学习进度详细
  Websites.getProcessview($scope).success(function(data) {
    $ionicLoading.hide();
  }).error(function(data) {
    $ionicLoading.hide();
  });
})
.controller('DetailCtrl', function($scope,$stateParams,Websites,$http,$ionicLoading,$state) {
  if (localStorage.haslogin != 1) {
        $state.go("tab.usercenter");
  }
  console.log('DetailCtrl');
  $scope.detailerror = "";
  $ionicLoading.show({
      template: 'Loading...'
  });
  $scope.userid = window.localStorage['userid'];
  $scope.title = $stateParams.title;
  $scope.item_track_id = $stateParams.item_track_id;
  //获取学习进度详细
  Websites.getProcessDetail($scope).success(function(data) {
    console.log($scope.detail);
    if($scope.detail.length==0){
      $scope.detailerror = "暂无数据";
    }
    $ionicLoading.hide();
  }).error(function(data) {
    $ionicLoading.hide();
  });
})


/**
 * 用户中心
 * @param  {[type]} $scope  [description]
 * @param  {[type]} $state) {             if (localStorage.haslogin ! [description]
 * @return {[type]}         [description]
 */
.controller('UsercenterCtrl', function($scope, $state,LoginService,$ionicLoading,$ionicPopup) {
  $scope.data = {};
    //强制显示返回button，默认情况下tabs里面独立页面不显示back button
    $scope.$on('$ionicView.beforeEnter', function (event, viewData) {
      viewData.enableBack = false;
    });
    if (localStorage.haslogin == 1) {
        $state.go("tab.account");
    }

    $scope.login = function() {
        console.log($scope.data.username);
        
        LoginService.loginUser($scope.data.username, $scope.data.password).success(function(data) {
            //登录成功
            localStorage.haslogin = 1;
            $ionicLoading.hide();
            $state.go("tab.account");
            console.log(1);

        }).error(function(data) {
            console.log('error login');
            localStorage.haslogin = 0
            var alertPopup = $ionicPopup.alert({
                title: '登录失败',
                okType: 'button-calm',
                okText: '确定',
                template: '请检查您填写的登陆信息！'
            });
        });
    }

    $scope.forget = function() {
        //进行API提交后，发送邮件，发送成功后，进行alert提醒
        $state.go('resetpassword');
    }

    $scope.goregister = function() {
        $state.go('register');
    }

  /*$scope.user = {
    id:12,
    img:'http://127.0.0.1/mynepapp/www/img/u_02.png',
    name:'尚未登录'
    //name:'李元熙'
  };*/
})

/**
 * 首页控制器
 */
.controller('HomeCtrl', function($scope, Websites, StorageService, $ionicLoading, $ionicSlideBoxDelegate,$ionicSideMenuDelegate,$stateParams,$state){
  var catId = $stateParams.catId == null ? localStorage.catId : $stateParams.catId;
  console.log(catId);
  //得到指定分类名称
  //Websites.getCategoryById($scope,catId);
  if(typeof(localStorage.categorystr) == 'undefined'){
      Websites.getCategory($scope).success(function(data){
          var categorystr = localStorage.categorystr;
          var categoryarr = JSON.parse(categorystr);

          if(catId == null || typeof(catId) == 'undefined'){
              catId = categoryarr[0].id;
              localStorage.catId = catId;
          }

          for(var i in categoryarr){
              if(categoryarr[i].id == catId){
                  $scope.category = categoryarr[i];
                  
                  console.log($scope.catId);
                  break;
              }
          }
          Websites.indexData($scope,catId).success(function(data) {
            $ionicLoading.hide();
            $ionicSlideBoxDelegate.update();
          }).error(function(data){
            //加载失败
            $ionicLoading.hide();
          });
      });
  }else{
      var categorystr = localStorage.categorystr;
      var categoryarr = JSON.parse(categorystr);

      if(catId == null || typeof(catId) == 'undefined'){
          catId = categoryarr[0].id;
          localStorage.catId = catId;
      }

      for(var i in categoryarr){
          if(categoryarr[i].id == catId){
              $scope.category = categoryarr[i];
              console.log(catId);
              console.log($scope.category);
              break;
          }
      }
      Websites.indexData($scope,catId).success(function(data) {
        $ionicLoading.hide();
        $ionicSlideBoxDelegate.update();
      }).error(function(data){
        //加载失败
        $ionicLoading.hide();
      });
  }
  
  
  
  //强制隐藏返回button，默认情况下tabs里面独立页面不显示back button
  $scope.$on('$ionicView.beforeEnter', function (event, viewData) {
      viewData.enableBack = false;
  });
  //var catId = $stateParams.catId;
  $ionicLoading.show({
      template: '数据加载中...'
  });
  //设置banner模块
  Websites.getBanner($scope);

  //设置课程模块
  //console.log(catId);
  //catId = typeof(catId) == 'undefined' ? localStorage.catId : catId;
  /*Websites.indexData($scope,catId).success(function(data) {
    $ionicLoading.hide();
    $ionicSlideBoxDelegate.update();
  }).error(function(data){
    //加载失败
    $ionicLoading.hide();
  });*/

  $scope.doRefresh = function() {
    Websites.indexData($scope,localStorage.catId);
    //Stop the ion-refresher from spinning
    $scope.$broadcast('scroll.refreshComplete');
  };

  $scope.openMenu = function () {
    $ionicSideMenuDelegate.toggleLeft();
    console.log(localStorage.haslogin);  
  }

  /**
   * 点击课程
   * @param  {[type]} courseid [description]
   * @return {[type]}          [description]
   */
  $scope.toCoursedetail = function(courseid) {
    console.log(courseid);
    //判断该课程是否已经购买
    if(localStorage.haslogin == 1){
      Websites.UserCourse($scope,courseid).success(function(){
        console.log('buycourse'+$scope.buycourse);
        if($scope.buycourse == 1){
          $state.go('coursenote',{productid:courseid});
          return;
        }else{
          $state.go('coursedetail',{productid:courseid});
        }
      })      
    }else{
      $state.go('coursedetail',{productid:courseid});
    }

    /*StorageService.getLocalstorage().then(function(data){
      console.log(data.haslogin);
      if(data.haslogin == 1){
        Websites.UserCourse($scope,courseid).success(function(){
          //console.log('buycourse'+$scope.buycourse);
          if($scope.buycourse == 1){
            $state.go('coursenote',{courseid:courseid});
            return;
          }else{
            $state.go('coursedetail',{courseid:courseid});
          }
        })      
      }
      $state.go('coursedetail',{courseid:courseid});
    },function(){
      $state.go('coursedetail',{courseid:courseid});
    })*/
  }
})

.controller('AllCourseCtrl', ['$scope', 'Websites', '$ionicLoading', '$state','$ionicSideMenuDelegate', function($scope, Websites, $ionicLoading, $state,$ionicSideMenuDelegate){
  $ionicLoading.show({
      template: '数据加载中...'
  });
  Websites.getAllCourse($scope).success(function(data) {
                console.log(data);

    $ionicLoading.hide();
  }).error(function(data) {
    $ionicLoading.hide();
  });
  $scope.openMenu = function () {
    $ionicSideMenuDelegate.toggleLeft();
  }
  $scope.tosearch = function(){
    $state.go("tab.search");
    console.log("tab.search");
  }
}])

/**
 * [登录类控制器：登录、忘记密码、注册等]
 * @param  {[type]} $scope          [description]
 * @param  {[type]} LoginService    [description]
 * @param  {[type]} $ionicPopup     [description]
 * @param  {[type]} $state          [description]
 * @param  {[type]} $ionicLoading   [description]
 * @param  {[type]} $window         [description]
 * @param  {Object} $ionicPlatform) {               $scope.data [description]
 * @return {[type]}                 [description]
 */
.controller('AccountCtrl', function($scope, LoginService, $ionicPopup, $state, $ionicLoading, $window, $ionicPlatform,Websites) {
  console.log('AccountCtrl');
  $scope.login = localStorage.haslogin;
  console.log($scope.login);
  if (localStorage.haslogin != 1) {
    $state.go("tab.usercenter");
  }else{
      /*Websites.getUserDetail($scope,window.localStorage['userid']).success(function(){
          $scope.detail = true;
      });*/
      $scope.headimg = localStorage.headimg!='null' ? localStorage.headimg : 'img/man1.png';
      $scope.name = localStorage.username;
      $scope.hide = true;
      $scope.settings = {
        enableFriends: true
      };
      
      $scope.toregister = function(){
        console.log(11);
      }
  }    
})

/**
 * 新闻详细信息
 * @param  {[type]} $scope      [description]
 * @return {[type]}             [description]
 */
.controller('NewsCtrl', ['$scope', 'Websites', '$stateParams', '$ionicLoading', '$ionicHistory', function($scope, Websites, $stateParams, $ionicLoading, $ionicHistory){
    $ionicLoading.show({
        template: '数据加载中...'
    });
    
    var newsid = $stateParams.newsid;
    Websites.getNewsdetail($scope, newsid).success(function(data) {
      console.log('success');
      $ionicLoading.hide();
    }).error(function(data){
      //加载失败
      console.log('failure');
      $ionicLoading.hide();
    });

    //强制显示返回button，默认情况下tabs里面独立页面不显示back button
    /*$scope.$on('$ionicView.beforeEnter', function (event, viewData) {
        viewData.enableBack = true;
    });

    $scope.gotoaccount = function() {
      $ionicHistory.goBack();
    }*/
}])


//   Sam   ------ 错题集列表控制器
.controller('ErrorlistCtrl', function($scope, $ionicPopup, $state, $ionicLoading, $ionicPlatform,Websites,$http) {
    var userid = window.localStorage['userid'];
    Websites.getErrorlist($scope,userid).success(function(data) {
      //$ionicLoading.hide();
      console.log(data);
    }).error(function(data){
      //加载失败
      $ionicLoading.hide();
    });
    $scope.errortype = {'0':'单项选择题','1':'多项选择题','2':'判断题','3':'课题解析'};
    //Sam   --------删除错题列表
    $scope.onItemDelete = function(index,courseid){
      var confirmPopup = $ionicPopup.confirm({
            title: '确认删除？',
            cancelText: '取消',
            okText: '确定'
        });
        confirmPopup.then(function(res) {
          if(res) {
            console.log('You are sure');
            Websites.DeleteError($scope,courseid,userid).success(function () {
              $scope.errorlist.splice(index,1);
            })
          }else{
              console.log('You are not sure');
          }
        });
    }
})

//   Sam   ------  错题详细页面
.controller('ErrordetailCtrl', function ($scope,$http,$location,$ionicSlideBoxDelegate,$stateParams,$ionicModal,$ionicLoading,Websites){
  $scope.radio = {checked:''};
  var userid = window.localStorage['userid'];
  var courseid = $stateParams.courseid;
  var coursename = $stateParams.course_name;
  var pageid = $stateParams.pageid;
  $scope.choice = {'0':'A','1':'B','2':'C','3':'D','4':'E','5':'F'};
  Websites.ErrorDetail($scope,courseid,pageid,userid).success(function(res){
    $scope.questions = res['question'];
    $scope.questype = res['questype'];
    $scope.total = res['total'];
    $scope.cardlist = res['card'];
    $scope.pagetitle = res['pagetitle'];
    $scope.params = res['params'];
    console.log($scope.questions);
    $ionicSlideBoxDelegate.update();
  })
  //Sam------答题卡modal
  $ionicModal.fromTemplateUrl('templates/d.html', {
    scope: $scope
  }).then(function(cards) {
    $scope.cards = cards;
    //$scope.modal.show();
  });
  $scope.toquestion = function(id){
    $ionicSlideBoxDelegate.slide(id-1);
    $scope.cards.hide();
  }
  //Sam------答题卡测试
  $scope.cardsshow = function() {
    console.log($scope.danxuan);
    console.log($scope.total+1);
    //单选题目数量
    $scope.danxuancount = [];
    for(var danxuan = 1; danxuan<$scope.danxuan+1; danxuan++){
      $scope.danxuancount.push(danxuan);
      var danxuanlast = danxuan;
    }
    //多选题目数量
    $scope.duoxuancount = [];
    for(var duoxuan = danxuanlast; duoxuan<$scope.duoxuan+danxuanlast; duoxuan++){
      $scope.duoxuancount.push(duoxuan);
    }
    // console.log($scope.numlist);
    $scope.cards.show();
  }
  // Sam ------ 答题卡跳转
  $scope.redirect = function(value) {
        //接收key key是题目的编号
        // 跳转到指定的题目页面
        // $ionicSlideBoxDelegate.slide(4);
        $scope.cards.hide();
        $ionicSlideBoxDelegate.slide(value-1);
  }
  
  // Sam  ---------  隐藏答题卡
  $scope.cardsHide = function() {
      // console.log('test');
      $scope.cards.hide();
  }
  //  Sam   --------  成绩结果返回按钮
  $scope.examurl = '/practice/errorlist';
  $scope.gourl = function(url){
      $location.path(url);
      $scope.modal.hide();
    }
})


//  Sam   ------   个人信息设置页面 
.controller('UserinfoCtrl', function($scope,$http,Websites,$ionicLoading,$ionicHistory,$state) {
  $scope.user = {
    id:12,
    img:'http://127.0.0.1/mynepapp/www/img/u_02.png',
    name:'尚未登录'
    //name:'李元熙'
  };

  Websites.getUserinfo($scope).success(function(data) {
      console.log('success');
      console.log(data);
      $scope.userdata = data.responseData;
      console.log($scope.userdata);
      console.log($scope.userdata[0]['title']);
      //if($scope.userdata[0]['content'] == '') $scope.userdata[0]['content'] = './img/u_02.png';
      //$scope.headimg = $scope.userdata[0]['content'];
      $scope.headimg = localStorage.headimg!='null' ? localStorage.headimg : 'img/man1.png';
      //$ionicLoading.hide();
    }).error(function(data){
      //加载失败
      console.log('fail');
      $ionicLoading.hide();
    });

  $scope.logout = function () {
    // body...
    localStorage.haslogin = 0;
    localStorage.removeItem('access_token');
    $state.go('tab.usercenter');
    //$ionicHistory.goBack();
  };

  $scope.$on('changeheadimg', function() {
      
      $scope.headimg = localStorage.headimg!='null' ? localStorage.headimg : 'img/man1.png';
      //$scope.headimg = typeof(window.headimg)!='undefined' ? window.headimg : 'img/man1.png';
      //console.log($scope.headimg);
      //alert($scope.headimg);
  });

})

//  Sam   ------   个人信息更改详细页面 
.controller('InfosettingCtrl', function($scope,$ionicLoading,$http,$stateParams,$state,Websites,$rootScope) {
  console.log($stateParams);
  console.log($stateParams.infotype);
  console.log($stateParams.text);

  $scope.user = {
    id:12,
    img:'http://127.0.0.1/mynepapp/www/img/u_02.png',
    name:'尚未登录'
    //name:'李元熙'
  };

  $scope.headimg = localStorage.headimg!='null' ? localStorage.headimg : 'img/man1.png';
  $scope.content = {};
  $scope.content.value = $stateParams.text;

  $scope.save = function(){
    console.log('helo');
    console.log($scope.content.value);
    $http.jsonp(ENV.yiiurl + 'mobileadmin/saveuser?access-token='+localStorage.access_token+'&field='+$stateParams.infotype+'&usercontent='+$scope.content.value+'&callback=JSON_CALLBACK')
        .then(function(res){
          console.log('suc');
          console.log($scope.content.value);
          $ionicLoading.show({ template: '修改成功', noBackdrop: true, duration: 1000 });
          $state.go('tab.userinfo')
      })
  }

  $scope.userkey = $stateParams.infotype;
  if ($stateParams.infotype == 'avatar')  $scope.title = '头像设置';
  if ($stateParams.infotype == 'name')  $scope.title = '姓名设置';
  if ($stateParams.infotype == 'email')  $scope.title = '电子邮件设置';
  if ($stateParams.infotype == 'mobile')  $scope.title = '移动电话设置';
  if ($stateParams.infotype == 'postcode')  $scope.title = '邮政编码设置';
  if ($stateParams.infotype == 'pass')  $scope.title = '密码设置';
  $scope.key = $stateParams.text;
  $scope.cleartext = function() {
    console.log('textclear');
    $scope.content.value = "";
  }

  $scope.$on('changeheadimg', function() {
      
      $scope.headimg = localStorage.headimg!='null' ? localStorage.headimg : 'img/man1.png';
      $scope.$apply();
      //$scope.headimg = typeof(window.headimg)!='undefined' ? window.headimg : 'img/man1.png';
      //console.log($scope.headimg);
      //alert($scope.headimg);
  });

  $scope.tocamera = function() {
      //console.log('tocamera'+localStorage.headimg);
      //localStorage.headimg = 'http://10.82.97.232/mynepappv1/api/backend/uploads/stu_photo/11.jpg';
      //$scope.headimg = localStorage.headimg;
      //$rootScope.$broadcast('changeheadimg');
      if(!navigator.camera || typeof(navigator.camera) == 'undefined' || typeof(CameraPopoverOptions) == 'undefined') {
          alert('camera is not defined');
          return;
      }
      var popover = new CameraPopoverOptions(0, 100, 200, 200, Camera.PopoverArrowDirection.ARROW_ANY);
      navigator.camera.getPicture(
          function (imageUriToUpload){
            
              //localStorage.headimg = 'http://10.82.97.232/mynepappv1/api/backend/uploads/stu_photo/11.jpg';
              //$scope.headimg = localStorage.headimg;
              //$scope.headimg = imageUriToUpload;
              var url=encodeURI(ENV.apiUrl+"mobileadmin/uploadimg?access-token="+localStorage.access_token);
              var params = new Object();
              var options = new FileUploadOptions();
              options.fileKey = "userimg"; //depends on the api
              options.fileName = imageUriToUpload.substr(imageUriToUpload.lastIndexOf('/')+1);
              options.mimeType = "image/jpeg";
              options.params = params;
              options.chunkedMode = true; //this is important to send both data and files
              var headers={'headerParam':'headerValue'};
              options.headers = headers;
              var ft = new FileTransfer();
              ft.upload(imageUriToUpload, url,
                  function (r) {
                    if(r.response!=null){
                      localStorage.headimg = r.response.substr(4);
                      $rootScope.$broadcast('changeheadimg');
                      //$scope.headimg = localStorage.headimg;
                      //alert("headimg:"+ $scope.headimg);
                    }
                      //console.log("Code = " + r.responseCode);
                      //alert("Response = " + r.response);
                      //alert("Sent = " + r.bytesSent);
                  },
                  function (error) {
                      //alert("An error has occurred: Code = " + error.code);
                      //alert("upload error source " + error.source);
                      //alert("upload error target " + error.target);
                  },
                  options);
          }
          , function (message) {
              //alert('Failed because: ' + message);
          }, { 
              quality: 60,
              destinationType: Camera.DestinationType.FILE_URI,
              sourceType: Camera.PictureSourceType.CAMERA,  //from camera
              allowEdit : true,
              encodingType: Camera.EncodingType.JPEG,
              targetWidth: 300,
              targetHeight: 300,
              popoverOptions  : popover,
              sourceType: 1,      // 0:Photo Library, 1=Camera, 2=Saved Photo Album
              encodingType: 0
          }
      );
      //$rootScope.$broadcast('changeheadimg');
      //$scope.headimg = localStorage.headimg;
      //alert($scope.headimg);
      //$state.go("tab.userinfo");
  }

  $scope.toimagepicker = function() {
      //console.log('toimagepicker');
      //$rootScope.$broadcast('changeheadimg');
      if(!navigator.camera || typeof(navigator.camera) == 'undefined' || typeof(CameraPopoverOptions) == 'undefined') {
          alert('camera is not defined');
          return;
      }
      var popover = new CameraPopoverOptions(0, 100, 200, 200, Camera.PopoverArrowDirection.ARROW_ANY);
        navigator.camera.getPicture(

            function (imageUriToUpload){

                $scope.headimg = imageUriToUpload;

                var url=encodeURI(ENV.apiUrl+"mobileadmin/uploadimg?access-token="+localStorage.access_token);
                //alert(url);
                var params = new Object();
                //params.userid = window.userid;  //you can send additional info with the file
                
                var options = new FileUploadOptions();
                options.fileKey = "userimg"; //depends on the api
                options.fileName = imageUriToUpload.substr(imageUriToUpload.lastIndexOf('/')+1);
                options.mimeType = "image/jpeg";
                options.params = params;
                options.chunkedMode = true; //this is important to send both data and files
                var headers={'headerParam':'headerValue'};
                options.headers = headers;
                var ft = new FileTransfer();
                //alert('upload13');
                ft.upload(imageUriToUpload, url, 
                    function (r) {
                      //$rootScope.$broadcast('loginUser');
                      if(r.response!=null){
                        localStorage.headimg = r.response.substr(4);
                        //$scope.headimg = localStorage.headimg;
                        //window.headimg = r.response.substr(4);
                        //$scope.headimg = window.headimg;
                        
                        //alert("headimg"+ localStorage.headimg);                       
                      }
                      $rootScope.$broadcast('changeheadimg');

                        /*alert("Code = " + r.responseCode);
                        alert("Response = " + r.response);
                        alert("Sent = " + r.bytesSent);*/
                        
                    },
                    function (error) {
                        /*alert("An error has occurred: Code = " + error.code);
                        alert("upload error source " + error.source);
                        alert("upload error target " + error.target);*/
                    },
                    options);
            }
            , function (message) {
                //alert('Failed because: ' + message);
            }, { 
                maximumImagesCount: 1,
                quality: 50,
                destinationType: Camera.DestinationType.FILE_URI,
                sourceType: Camera.PictureSourceType.PHOTOLIBRARY, //from photolibrary
                //sourceType: Camera.PictureSourceType.CAMERA, //from photolibrary
                allowEdit : true,
                encodingType: Camera.EncodingType.JPEG,
                targetWidth: 300,
                targetHeight: 300,
                popoverOptions  : popover
            }
        );
        //$rootScope.$broadcast('changeheadimg');
        //$scope.headimg = localStorage.headimg;
        //$state.go("tab.userinfo");
  }
})

//Sam   --- 我的课程页面 
.controller('MycourseCtrl', function($scope,$ionicLoading,$http,$stateParams,$state,Websites) {
  if (localStorage.haslogin != 1) {
      $state.go("tab.usercenter");
      return;
  }else{
      Websites.getUserCourse($scope).success(function(data) {
      //$ionicLoading.hide();
      console.log($scope.courselist[0].id);
    }).error(function(data){
      //加载失败
      console.log('fail');
      $ionicLoading.hide();
    });
  }
})

//Sam   --- 报班页面
.controller('ApplycourseCtrl', function($scope,$http,$stateParams,Websites,$ionicLoading,$ionicHistory,$state) {
  var typeid = $stateParams.typeid;
  console.log(typeid);
  $scope.tosearch = function(){
    $state.go("tab.search");
    console.log("tab.search");
  }
  if (localStorage.haslogin != 1) {
      $state.go("tab.usercenter");
      return;
  }else{
      Websites.applyCourse($scope, typeid).success(function(data) {
      //$ionicLoading.hide();
    }).error(function(data){
      //加载失败
      console.log('fail');
      $ionicLoading.hide();
    });
  }
})

//Sam  ---- 课程包页面
.controller('CoursepageCtrl', function($scope,$http,$stateParams,Websites,$ionicLoading,$ionicHistory,$state) {
  var typeid = $stateParams.typeid;
  if (localStorage.haslogin != 1) {
      $state.go("tab.usercenter");
      return;
  }else{
      Websites.coursePage($scope,typeid).success(function(data) {
      //$ionicLoading.hide();
    }).error(function(data){
      //加载失败
      console.log('fail');
      $ionicLoading.hide();
    });
  }
})

// Sam  地址页面
.controller('AddressCtrl', function($scope,$http,Websites,$ionicLoading,$ionicHistory,$state) {
  if (localStorage.haslogin != 1) {
      $state.go("tab.usercenter");
      return;
  }else{
      Websites.getAddress($scope).success(function(data) {
      //$ionicLoading.hide();
      $scope.addresslist = data.responseData;
      console.log($scope.addresslist);
      for(var i in $scope.addresslist) {
        console.log($scope.addresslist[i].choose_mark);
        if ($scope.addresslist[i].choose_mark==1) {
          $scope.addressid = $scope.addresslist[i].id;
          console.log($scope.addressid);
        }
      }
    }).error(function(data){
      //加载失败
      console.log('fail');
      $ionicLoading.hide();
    });
  }
   $scope.getMark = function(addressid){
    $scope.addressid = addressid;
    var id = addressid;
    Websites.editSelectedAddress($scope,id);
  }
})

//Sam  ---- 课程包页面
.controller('MycollectionCtrl', function($scope,$http,Websites,$ionicLoading,$ionicHistory,$state) {
  if (localStorage.haslogin != 1) {
      $state.go("tab.usercenter");
      return;
  }else{
      Websites.getMyCollection($scope).success(function(data) {
      //$ionicLoading.hide();
    }).error(function(data){
      //加载失败
      console.log('fail');
      $ionicLoading.hide();
    });
  }
})

//Sam  ---- 历史记录
.controller('MyhistoryCtrl', function($scope,$http,Websites,$ionicLoading,$ionicHistory,$state) {
  if (localStorage.haslogin != 1) {
      $state.go("tab.usercenter");
      return;
  }else{
      Websites.getMyHistory($scope).success(function(data) {
      //$ionicLoading.hide();
    }).error(function(data){
      //加载失败
      console.log('fail');
      $ionicLoading.hide();
    });
  }
})

//Sam  ---- 课程答疑、笔记页面
//.controller('CoursenoteCtrl', function($scope,$http,Websites,$ionicLoading,$ionicHistory,$state) {
.controller('CoursenoteCtrl', ['$scope', '$http', 'Websites', '$stateParams', '$rootScope', '$ionicPopup', '$ionicLoading', '$ionicHistory', '$state', '$ionicViewSwitcher', '$timeout', '$cordovaFileTransfer', '$ionicPlatform', '$ionicModal' ,function($scope, $http, Websites, $stateParams, $rootScope, $ionicPopup, $ionicLoading, $ionicHistory, $state,$ionicViewSwitcher,$timeout,$cordovaFileTransfer,$ionicPlatform,$ionicModal){
//.controller('CoursenoteCtrl', function($scope,$http,Websites,$ionicLoading,$ionicHistory,$state,$rootScope,$ionicViewSwitcher,$ionicModal) {
  //back button
  //强制显示返回button，默认情况下tabs里面独立页面不显示back button
  
  $ionicModal.fromTemplateUrl('templates/courseinput.html', {
      scope: $scope,
      animation: 'slide-in-up'
  }).then(function(modal) {
      $scope.modal = modal;
  });
  //返回的动画效果，默认情况下强制显示的返回button无动画效果
  //播放器id的后缀
  //控制内容页高度
  $scope.grid_height = {height:''+document.body.offsetHeight*0.65-104+'px'};
  var productid = $stateParams.productid;
  console.log(productid);
  productid = typeof(productid) == 'undefined'?'0':productid;
  $scope.productid = productid;
  console.log($scope.productid);
  $scope.userid = window.localStorage['userid'];

  $scope.jpcid = 'jp_container_' + new Date().getTime();
  var course_dtd = Websites.directoryData($scope);

  $scope.$on('$ionicView.beforeEnter', function (event, viewData) {
      viewData.enableBack = true;
      console.log('cache');
      course_dtd.success(function(data) {
          //$ionicLoading.hide();
        if (!$scope.citemid) return;
        //播放器初始化
        //Job.proxyUrl = ENV.proxyUrl;
        Job.proxyUrl = ENV.apiUrl + 'course/proxy';
        var jpcid = $scope.jpcid;
        setTimeout(function initp() {
        var p = document.getElementById(jpcid);
        if (p) {
          Job.init_player(jpcid, {config: ENV.apiUrl + 'course/startupxml?courseid='+$scope.ccourseid+'&itemid='+$scope.citemid+'&access-token='+localStorage.access_token}, $scope.citemid);
          Job.on('nextVideo', function() {
			  var next_itemid = $scope.get_next_itemid();
			  if (!next_itemid) {
				Websites.showMessage($ionicLoading,'已到本课程最后一节');
				return;
			  }
			  $scope.setActive(next_itemid,0,$scope.ccourseid);
          });
          return;
        }
        setTimeout(initp, 50);
        }, 50);

        }).error(function(data){
          //加载失败
          $ionicLoading.hide();
      });
  });

  $scope.get_next_itemid = function() {
	  var next_itemid = null;
	  for (var i=0; i<$scope.courses.length; i++) {
		if ($scope.courses[i].id != $scope.ccourseid) continue;
		var items = $scope.courses[i].items;
		var cflag = false;
		for (var j=0; j<items.length; j++) {
		  if (cflag) {
			if (items[j].vtype != 0) continue;
			next_itemid = items[j].itemid;
			break;
		  }
		  if (items[j].itemid != $scope.citemid) continue;
		  cflag = true;
		}
		break;
	  }
	  return next_itemid;
  };
  $scope.$on('$ionicView.beforeLeave', function (event, viewData) {
      $ionicViewSwitcher.nextDirection("back");
	    //销毁播放器
	    Job.destroy();
  });

  // //back button
  // $scope.$on('$ionicView.beforeEnter', function (event, viewData) {
  //     viewData.enableBack = true;
  //   });
  
  // //返回的动画效果，默认情况下强制显示的返回button无动画效果
  // $scope.$on('$ionicView.beforeLeave', function (event, viewData) {
  //   $ionicViewSwitcher.nextDirection("back");
  // });

  $scope.haslogin = localStorage.haslogin;
  $scope.favorites = 0;
  //取到收藏状态
  Websites.getcollection($scope);
  
  
  $scope.ChangeHeight = function(){
    $scope.grid_height = {'height':''+document.body.offsetHeight*0.65-104+'px'};
    $rootScope.$broadcast('grid_height');
    console.log($scope.grid_height);

  }
  $scope.answer = function () {
    // body...
    $scope.modal.show();
  }
  $scope.answerclose = function () {
    // body...
    $scope.modal.hide();
  }

  if (localStorage.haslogin != 1) {
      $state.go("tab.usercenter");
      return;
  }else{
	  Websites.questionData($scope);
	  Websites.noteData($scope);
  }

    //$scope.timelast = '15:02';
    
    /**
     * 切换课件
     * @param {[type]} menuItem [description]
     */
    $scope.setActive = function(itemid,vtype,courseid) {
      if(vtype == 0){
      			var courseData = $scope.courseData;
      			if (itemid != $scope.citemid) {
					$scope.citemid = itemid;
					$scope.ccourseid = courseid;
					console.log(itemid, courseid);
      				//Job.changeVideo(ENV.postUrl2 + 'courseid/'+courseData.id+'/itemid/'+menuItem+'/userid/'+$scope.userid, menuItem);
      				Job.changeVideo(ENV.apiUrl + 'course/startupxml?courseid='+courseid+'&itemid='+itemid+'&access-token='+localStorage.access_token, itemid);
      				//courseData.itemid = menuItem;
      			}
        }else{
            Websites.showMessage($ionicLoading,'本课件不是单屏课件，无法观看');
        }
    };

	  //设置答疑内容（默认为空）
	  $scope.quizcreate = {
		'title': '',
		'content': ''
	  };
	  //设置笔记内容（默认为空）
	  $scope.notecreate = {
		'content': ''
	  };
    /**
     * 提交答疑
     * @param {[type]} menuItem [description]
     */
	$scope.addQuiz = function() {
		if (!$scope.quizcreate.content) {
			var alertPopup = $ionicPopup.alert({
				title: '格式不合法',
				template: '请确认答疑内容不能为空！',
				buttons: [{ //Array[Object] (可选)。放在弹窗footer内的按钮。
				  text: 'OK',
				  type: 'button-calm',
				}]
			});
		}else{
			$http.jsonp(ENV.apiUrl + 'course/addquiz?access-token='+localStorage.access_token+'&courseid='+$scope.ccourseid+'&title='+$scope.quizcreate.title+'&content='+$scope.quizcreate.content+'&callback=JSON_CALLBACK')
				.success(function(data) {
					Websites.showMessage($ionicLoading,'发布成功');
				  Websites.questionData($scope);
				  //发帖成功清除数据
				  $scope.quizcreate = {
					'title': '',
					'content': ''
				  };
				});
		}
	};
    /**
     * 提交笔记
     * @param {[type]} menuItem [description]
     */
	$scope.addNote = function() {
		if (!$scope.notecreate.content) {
			var alertPopup = $ionicPopup.alert({
				title: '格式不合法',
				template: '请确认笔记内容不能为空！',
				buttons: [{ //Array[Object] (可选)。放在弹窗footer内的按钮。
				  text: 'OK',
				  type: 'button-calm',
				}]
			});
		}else{
			var note_time = Job.conf && Job.conf.lastViewedTime || 0;
			$http.jsonp(ENV.apiUrl + 'course/addnote?access-token='+localStorage.access_token+'&courseid='+$scope.ccourseid+'&itemid='+$scope.citemid+'&content='+$scope.notecreate.content+'&note_time='+note_time+'&callback=JSON_CALLBACK')
				.success(function(data) {
					Websites.showMessage($ionicLoading,'发布成功');
				  Websites.noteData($scope);
				  //发帖成功清除数据
				  $scope.notecreate = {
					'content': ''
				  };
				  $scope.answerclose();
				});
		}
	};
  //删除笔记
  $scope.deletenote = function(id){
    Websites.DeleteNote($scope,id).success(function(data){
      //删除成功
      if(data.flag==1){
        Websites.noteData($scope);
      }else{
        //删除失败
        $ionicLoading.show({
          template: '删除出错'
        });
        $timeout(function() {
          $ionicLoading.hide();
        }, 1000);
      }
    })
  };

    /**
     * 收藏课程
     * @return {[type]} [description]
     */
    $scope.toFavorites=function(productid) {
        if(localStorage.haslogin == 1){
            console.log('toFavorites');
            var favorites = 1 - $scope.favorites;
            var msg = favorites == 1 ? '取消收藏': '收藏成功';
            $scope.favorites = favorites;
            console.log('favorites'+favorites);
            Websites.dealcollection($scope,productid,favorites).success(function(){
              //Websites.showMessage($ionicLoading,msg);
            });
        }else{
            var confirmPopup = $ionicPopup.confirm({
               title: '',
               template: '匿名用户无法收藏课程，请登录',
               cssClass: 'comfirmText',
               buttons: [
                { text: '再看看' },
                {
                  text: '立即登录',
                  type: 'button-calm',
                  onTap: function(e) {
                      $state.go("tab.usercenter");
                  }
                }
              ]
             });
             confirmPopup.then(function(res) {
               if(res) {
                 console.log('You are sure');
               } else {
                 console.log('You are not sure');
               }
             });
        }        
        //console.log($scope.courseData);
    };

    /**
     * 显示下载视频页面
     * @return {[type]} [description]
     */
    
    $ionicModal.fromTemplateUrl('templates/downloadvideo.html', {
      scope: $scope,
      animation: 'slide-in-up'
    }).then(function(modal) {
      $scope.modal = modal;

    });

    $scope.toDownlaod = function(){
        console.log('download video');
        //Websites.directoryData($scope);
        
        if(localStorage.haslogin == 1){
            $scope.modal.show();
            $scope.selected = false;
            $scope.selectallv = false;
        }else{
            var confirmPopup = $ionicPopup.confirm({
               title: '',
               template: '匿名用户无法下载课程，请登录',
               cssClass: 'comfirmText',
               buttons: [
                { text: '再看看' },
                {
                  text: '立即登录',
                  type: 'button-calm',
                  onTap: function(e) {
                      $state.go("tab.usercenter");
                  }
                }
              ]
             });

             confirmPopup.then(function(res) {
               if(res) {
                 console.log('You are sure');
               } else {
                 console.log('You are not sure');
               }
             });
        }
    };

    /**
     * 关闭modal
     * @return {[type]} [description]
     */
    $scope.toClose = function(){
        $scope.modal.hide();
        $scope.downloadVideoarr = [];
    }

    /**
     * 保存下载列表
     * @param {[type]} menuItem [description]
     */
    $scope.downloadVideoarr = [];
    $scope.setDownload = function(menuItem,selected) {
        console.log(selected);
        //selected=!selected;
        var len = 0;
        var index = $scope.downloadVideoarr.indexOf(menuItem);
        //if(selected){
            if(index<0){
              len = $scope.downloadVideoarr.push(menuItem);
            }
        //}else{
            //var index = $scope.downloadVideoarr.indexOf(menuItem);
            if(index>-1){
                $scope.downloadVideoarr.splice(index,1);
            }
            
        //}
        len = $scope.downloadVideoarr.length;
        $scope.len = len;
        //$scope.downloadVideoarr = downloadVideoarr;
        //console.log(downloadVideoarr);
        $scope.cselected = selected;
    };

    /**
     * 全选
     * @return {[type]} [description]
     */
    $scope.selectAll = function(all){
      var downloadVideoarr = [];
      if(all){
        $scope.selected = true;
        var len = 0;        
        for(i in $scope.courses){
            for(ii in $scope.courses[i].items){
                len = downloadVideoarr.push($scope.courses[i].items[ii].itemid);
            }
        }
        $scope.len = len;
      }else{
        $scope.selected = false;
        $scope.len = 0;

      }
      $scope.downloadVideoarr = downloadVideoarr;
      //console.log(downloadVideoarr);
    };

    /**
     * 下载视频
     * @return {[type]} [description]
     */
    $scope.downloadMultiVideo = function(){
        console.log($scope.downloadVideoarr);
    };

 
}])

//课程绑定码
.controller('CodeCtrl', function($scope,Websites,$state,$ionicLoading,$timeout) {
  $scope.code = {'text':''};
  $scope.binding = function(){
    console.log($scope.code.text.length);
	var ccode = $scope.code.text;
	if (ccode && /\w{20}/.test(ccode)) {
      console.log($scope.code);
      Websites.bindCode($scope,ccode).success(function(data){
        if (data.flag) {
          $scope.codeSuccess('绑定成功');
		  $scope.code = {'text':''};
        }else{
          $scope.showMessage(data.error);
        }
      })
    }else{
      $scope.showMessage('绑定码格式不对');
    }
  }
  $scope.showMessage = function(title){
    $ionicLoading.show({
      template: title
    });
    $timeout(function() {
      $ionicLoading.hide();
    }, 1000);
  }
  $scope.codeSuccess = function(title){
    $ionicLoading.show({
      template: title
    });
    $timeout(function() {
      $ionicLoading.hide();
      $state.go('tab.account');
    }, 1000);
  }

})
//Sam  ----  离线换存 下载页面
.controller('DownloadCtrl', function($scope,$http,Websites,$ionicLoading,$ionicViewSwitcher,$ionicHistory,$state) {
  //强制显示返回button，默认情况下tabs里面独立页面不显示back button
  $scope.$on('$ionicView.beforeEnter', function (event, viewData) {
      viewData.enableBack = true;
  });
  //返回的动画效果，默认情况下强制显示的返回button无动画效果
  $scope.$on('$ionicView.beforeLeave', function (event, viewData) {
      $ionicViewSwitcher.nextDirection("back");
  });

  if (localStorage.haslogin != 1) {
      $state.go("tab.usercenter");
      return;
    }else{
      Websites.getDownloaded($scope).success(function(data) {
      //$ionicLoading.hide();
    }).error(function(data){
      //加载失败
      console.log('fail');
      $ionicLoading.hide();
    });
    Websites.getDownloading($scope).success(function(data) {
      //$ionicLoading.hide();
    }).error(function(data){
      //加载失败
      console.log('fail');
      $ionicLoading.hide();
    });
  }
})

//Sam  ----  离线换存 二级页面
.controller('DlsecpageCtrl', function($scope,$http,Websites,$ionicLoading,$ionicViewSwitcher,$ionicHistory,$state) {

  //back button
  $scope.$on('$ionicView.beforeEnter', function (event, viewData) {
      viewData.enableBack = true;
    });
  
  //返回的动画效果，默认情况下强制显示的返回button无动画效果
  $scope.$on('$ionicView.beforeLeave', function (event, viewData) {
    $ionicViewSwitcher.nextDirection("back");
  });

  $scope.test = '基金投资指南与实际操作';
  Websites.directoryData($scope).success(function(data) {
      //$ionicLoading.hide();
    }).error(function(data){
      //加载失败
      $ionicLoading.hide();
  });



});
